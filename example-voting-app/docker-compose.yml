version: "2"

services:
  voting-app:
    image: n1koo/votingapp_voting-app
    volumes:
     - ./voting-app:/app
    ports:
      - "80"
    networks:
      - front-tier
      - back-tier
    links:
      - interlock:interlock
    environment:
      - INTERLOCK_DATA={"hostname":"votingapp","domain":"docker"}

  result-app:
    image: n1koo/votingapp_result-app
    volumes:
      - ./result-app:/app
    ports:
      - "80"
    networks:
      - front-tier
      - back-tier

  worker:
    image: manomarks/worker
    networks:
      - back-tier

  redis:
    image: redis:alpine
    ports: ["6379"]
    networks:
      - back-tier

  db:
    image: postgres:9.4
    volumes:
      - "db-data:/var/lib/postgresql/data"
    networks:
      - back-tier

  interlock:
    image: ehazlett/interlock:latest
    ports:
      - "5003:80"
    volumes:
      - /var/lib/boot2docker:/etc/docker
    environment:
      - "constraint:node==swarm-master"
    command: "--swarm-url https://192.168.99.116:3376 --swarm-tls-ca-cert=/etc/docker/ca.pem --swarm-tls-cert=/etc/docker/server.pem --swarm-tls-key=/etc/docker/server-key.pem --debug --plugin haproxy start"

volumes:
  db-data:

networks:
  front-tier: 
    driver: overlay
  back-tier: 
    driver: overlay
